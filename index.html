<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SportsPro Admin Login</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 (Popups) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- SortableJS (Drag & Drop) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- Chart.js (For Graphs) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-dark: #0f111a;
            --sidebar-bg: #151823;
            --card-bg: #1e212d;
            --primary-color: #e50914;
            --text-color: #a0a6b5;
            --sidebar-width: 260px;
        }

        body { background-color: var(--bg-dark); color: var(--text-color); font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }

        /* Login Screen Styles */
        #login-section {
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle at center, #1e212d 0%, #0f111a 100%);
            position: fixed; top: 0; left: 0; width: 100%; z-index: 2000;
        }
        .login-card {
            width: 100%;
            max-width: 400px;
            background-color: var(--sidebar-bg);
            padding: 40px;
            border-radius: 15px;
            border: 1px solid #2a2d3a;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            margin: 20px;
        }
        .login-logo { font-size: 32px; font-weight: 800; color: white; text-align: center; margin-bottom: 30px; }
        .login-logo span { color: var(--primary-color); font-style: italic; }

        /* Main Panel */
        #admin-panel { display: none; min-height: 100vh; }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width); height: 100vh; background-color: var(--sidebar-bg);
            position: fixed; top: 0; left: 0; padding: 20px;
            border-right: 1px solid #2a2d3a; z-index: 1000;
            transition: transform 0.3s ease;
        }
        .brand-logo { font-size: 24px; font-weight: 800; color: white; margin-bottom: 40px; }
        .brand-logo span { color: var(--primary-color); font-style: italic; }
        .nav-link {
            color: var(--text-color); padding: 12px 15px; border-radius: 8px; margin-bottom: 5px;
            transition: all 0.3s; display: flex; align-items: center; gap: 12px; text-decoration: none; font-weight: 500; cursor: pointer;
        }
        .nav-link:hover, .nav-link.active { background-color: rgba(229, 9, 20, 0.15); color: var(--primary-color); }
        .nav-link i { width: 20px; text-align: center; }

        .btn-logout {
            margin-top: auto; 
            background: rgba(255, 255, 255, 0.05); 
            color: #ff4757;
            border: none;
            width: 100%;
        }
        .btn-logout:hover { background: rgba(255, 71, 87, 0.1); color: #ff4757; }

        /* Main Content */
        .main-content { margin-left: var(--sidebar-width); padding: 30px; transition: margin 0.3s ease; }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.mobile-active { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 15px; }
            .mobile-nav-toggle { display: block !important; position: fixed; top: 15px; right: 15px; z-index: 1100; }
        }

        /* Cards */
        .custom-card { 
            background-color: var(--card-bg); 
            border-radius: 12px; 
            padding: 20px; 
            border: 1px solid #2a2d3a; 
            margin-bottom: 20px; 
            height: 100%;
        }
        .stats-info h3 { font-size: 28px; color: white; margin: 0; font-weight: 700; }
        
        /* Stats Cards Gradient */
        .card-gradient-1 { background: linear-gradient(45deg, #1e212d, #2a1e2d); }
        .card-gradient-2 { background: linear-gradient(45deg, #1e212d, #1e2a2d); }
        .card-gradient-3 { background: linear-gradient(45deg, #1e212d, #2d261e); }
        .card-gradient-4 { background: linear-gradient(45deg, #1e212d, #2d1e1e); }

        /* Tables */
        .table-dark { --bs-table-bg: transparent; --bs-table-color: var(--text-color); --bs-table-border-color: #2a2d3a; }
        .table-dark th { color: #fff; font-weight: 600; text-transform: uppercase; font-size: 12px; }
        .table-dark td { vertical-align: middle; }
        .draggable-row { cursor: grab; }
        .draggable-row:active { cursor: grabbing; background-color: #2a2d3a; }
        .channel-img-preview { width: 40px; height: 40px; object-fit: contain; background: #fff; padding: 2px; border-radius: 4px; }
        .team-logo-sm { width: 30px; height: 30px; object-fit: contain; background: #fff; border-radius: 50%; padding: 2px; }
        .expired-row { opacity: 0.6; background: rgba(255,0,0,0.05); }

        /* Forms */
        .form-control, .form-select { background-color: #151823; border: 1px solid #333; color: white; }
        .form-control:focus, .form-select:focus { background-color: #151823; border-color: var(--primary-color); color: white; box-shadow: none; }
        .form-control::placeholder { color: #555; }
        textarea.form-control { min-height: 100px; font-family: monospace; font-size: 13px; color: #fff; }

        /* NEW: Dark Tabs Styling */
        .nav-tabs { border-bottom: 1px solid #2a2d3a; margin-bottom: 20px; }
        .nav-tabs .nav-link { color: var(--text-color); border: none; background: transparent; padding: 10px 20px; font-weight: 600; margin-right: 5px; }
        .nav-tabs .nav-link:hover { color: white; background: rgba(255,255,255,0.05); border-radius: 5px 5px 0 0; }
        .nav-tabs .nav-link.active { color: white; background-color: var(--primary-color); border-radius: 5px 5px 0 0; }

        /* Modal */
        .modal-content { background-color: var(--card-bg); color: white; border: 1px solid #333; }
        .modal-header, .modal-footer { border-color: #333; }
        .btn-primary { background-color: var(--primary-color); border: none; }
        .btn-primary:hover { background-color: #c40812; }
        .btn-close-white { filter: invert(1); }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #151823; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #e50914; }
    </style>
</head>
<body>

    <!-- Mobile Menu Toggle -->
    <button class="btn btn-primary mobile-nav-toggle" style="display:none;" onclick="toggleMobileSidebar()">
        <i class="fa-solid fa-bars"></i>
    </button>

    <!-- 1. LOGIN SECTION -->
    <div id="login-section">
        <div class="login-card">
            <div class="login-logo"><i class="fa-solid fa-play-circle"></i> Sports<span>Pro</span></div>
            <p class="text-center text-secondary mb-4">Admin Console Access</p>
            
            <div class="mb-3">
                <label class="form-label text-white">Email Address</label>
                <input type="email" id="loginEmail" class="form-control" placeholder="admin@example.com">
            </div>
            <div class="mb-4">
                <label class="form-label text-white">Password</label>
                <input type="password" id="loginPass" class="form-control" placeholder="••••••••">
            </div>
            <button class="btn btn-primary w-100 py-2 fw-bold" id="btnLogin">
                <span id="btnText">LOGIN</span>
                <div id="btnSpinner" class="spinner-border spinner-border-sm text-white ms-2" style="display:none;"></div>
            </button>
        </div>
    </div>

    <!-- 2. ADMIN PANEL (Initially Hidden) -->
    <div id="admin-panel">
        
        <!-- Sidebar Navigation -->
        <div class="sidebar d-flex flex-column" id="sidebar">
            <div class="brand-logo"><i class="fa-solid fa-play-circle"></i> Sports<span>Pro</span></div>
            <nav class="nav flex-column flex-grow-1">
                <div class="nav-link active" onclick="showSection('dashboard', this)">
                    <i class="fa-solid fa-chart-pie"></i> Dashboard
                </div>

                <div class="nav-link" onclick="showSection('matches', this)">
                    <i class="fa-solid fa-futbol"></i> Manage Matches
                </div>

                <!-- Manage Teams/Leagues -->
                <div class="nav-link" onclick="showSection('teams', this)">
                    <i class="fa-solid fa-users-line"></i> Teams & Leagues
                </div>
                
                <div class="nav-link" onclick="showSection('channels', this)">
                    <i class="fa-solid fa-tv"></i> Manage Channels
                </div>
                <div class="nav-link" onclick="showSection('categories', this)">
                    <i class="fa-solid fa-tags"></i> Channel Categories
                </div>

                <div class="nav-link" onclick="showSection('settings', this)">
                    <i class="fa-solid fa-gear"></i> App Settings
                </div>
                <div class="nav-link" onclick="showSection('ads', this)">
                    <i class="fa-solid fa-rectangle-ad"></i> Ads Manager
                </div>
            </nav>
            <!-- Logout Button -->
            <button class="btn-logout nav-link justify-content-center" id="btnLogout">
                <i class="fa-solid fa-sign-out-alt"></i> Logout
            </button>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            
            <!-- DASHBOARD -->
            <div id="section-dashboard">
                <h4 class="text-white mb-4">Content Overview</h4>
                
                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <div class="custom-card d-flex justify-content-between align-items-center" style="border-color: #00ff9d;">
                            <div class="stats-info">
                                <h3 id="activeUsers" class="text-success">0</h3>
                                <p class="m-0 text-white">Online Now</p>
                            </div>
                            <div class="spinner-grow text-success" role="status" style="width: 2rem; height: 2rem;"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="custom-card d-flex justify-content-between align-items-center">
                            <div class="stats-info"><h3 id="totalChannels">0</h3><p class="m-0">Total Channels</p></div>
                            <i class="fa-solid fa-tv fs-2 text-danger"></i>
                        </div>
                    </div>
                </div>

                <h4 class="text-white mb-3 mt-5">User Installation Stats</h4>
                <div class="row g-4 mb-4">
                    <div class="col-md-3 col-6">
                        <div class="custom-card card-gradient-4 border-0">
                            <div><p class="text-secondary mb-1">Total Users</p><h3 class="text-white fw-bold" id="installTotal">0</h3></div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="custom-card card-gradient-1 border-0">
                            <div><p class="text-secondary mb-1">New Today</p><h3 class="text-white fw-bold" id="installToday">0</h3></div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="custom-card card-gradient-2 border-0">
                            <div><p class="text-secondary mb-1">This Week</p><h3 class="text-white fw-bold" id="installWeek">0</h3></div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="custom-card card-gradient-3 border-0">
                            <div><p class="text-secondary mb-1">This Month</p><h3 class="text-white fw-bold" id="installMonth">0</h3></div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="custom-card">
                            <h5 class="text-white mb-4">Installation Growth (Last 7 Days)</h5>
                            <div style="height: 300px;"><canvas id="installChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MATCH MANAGER -->
            <div id="section-matches" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="text-white m-0">Live Match Manager</h4>
                    <div class="d-flex gap-2">
                        <button class="btn btn-danger btn-sm" onclick="clearExpiredMatches()"><i class="fa-solid fa-trash-can"></i> Clear Expired</button>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#matchModal" onclick="resetMatchForm()"><i class="fa-solid fa-plus"></i> Add Match</button>
                    </div>
                </div>
                <!-- Table Container with scrolling -->
                <div class="custom-card p-0" style="overflow-x: auto;">
                    <table class="table table-dark table-hover mb-0">
                        <thead>
                            <tr>
                                <th class="ps-4">Status</th>
                                <th>Series/League</th>
                                <th>Teams</th>
                                <th>Start Time</th>
                                <th>Duration</th>
                                <th class="text-end pe-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="matchTableBody">
                            <!-- Matches will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TEAMS & LEAGUES MANAGER (DESIGN UPDATED: TABS) -->
            <div id="section-teams" style="display: none;">
                <h4 class="text-white mb-4">Manage Teams & Leagues</h4>
                
                <!-- Nav Tabs -->
                <ul class="nav nav-tabs" id="teamLeagueTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-teams-btn" data-bs-toggle="tab" data-bs-target="#tab-teams-pane" type="button">Teams</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-leagues-btn" data-bs-toggle="tab" data-bs-target="#tab-leagues-pane" type="button">Leagues / Series</button>
                    </li>
                </ul>

                <div class="tab-content">
                    
                    <!-- TAB 1: TEAMS MANAGER -->
                    <div class="tab-pane fade show active" id="tab-teams-pane">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="text-white m-0">Team List</h5>
                            <!-- Filter Dropdown -->
                            <select id="teamListFilter" class="form-select w-auto" style="min-width: 200px;" onchange="renderTeamTable()">
                                <option value="All">All Leagues</option>
                            </select>
                        </div>

                        <!-- Add Team Form -->
                        <div class="custom-card mb-3">
                            <label class="form-label text-info">Add New Team</label>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <select id="newTeamLeague" class="form-select">
                                        <option value="">Select League...</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="text" id="newTeamName" class="form-control" placeholder="Team Name">
                                </div>
                                <div class="col-md-3">
                                    <input type="text" id="newTeamLogo" class="form-control" placeholder="Logo URL">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-primary w-100" id="btnAddTeam">Add</button>
                                </div>
                            </div>
                        </div>

                        <!-- Full Width Table -->
                        <div class="custom-card p-0 overflow-hidden">
                            <table class="table table-dark table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th class="ps-4">Logo</th>
                                        <th>Team Name</th>
                                        <th>League ID</th>
                                        <th class="text-end pe-4">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="teamTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- TAB 2: LEAGUES MANAGER -->
                    <div class="tab-pane fade" id="tab-leagues-pane">
                        <h5 class="text-white mb-3">League List</h5>
                        
                        <div class="custom-card mb-3">
                            <label class="form-label text-warning">Add New League</label>
                            <div class="input-group">
                                <input type="text" id="newLeagueName" class="form-control" placeholder="e.g. IPL 2025">
                                <button class="btn btn-primary" id="btnAddLeague">Add League</button>
                            </div>
                        </div>
                        
                        <!-- Full Width Table -->
                        <div class="custom-card p-0 overflow-hidden">
                            <table class="table table-dark table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th class="ps-4">League Name</th>
                                        <th class="text-end pe-4">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="leagueTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>

            <!-- SETTINGS -->
            <div id="section-settings" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="text-white m-0">App Configuration</h4>
                    <button class="btn btn-primary" id="saveSettingsBtn"><i class="fa-solid fa-save"></i> Save</button>
                </div>
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="custom-card">
                            <h5 class="text-white mb-3">App Links</h5>
                            <div class="mb-3"><label class="form-label text-warning">Channel Request Link</label><input type="text" id="requestUrl" class="form-control"></div>
                            <div class="mb-3"><label class="form-label text-success">Share App Link</label><input type="text" id="shareUrl" class="form-control"></div>
                            <div class="mb-3"><label class="form-label text-info">Update URL</label><input type="text" id="updateUrl" class="form-control"></div>
                            <div class="mb-3 p-3" style="background: rgba(229, 9, 20, 0.1); border: 1px dashed #e50914; border-radius: 8px;">
                                <label class="form-label text-danger fw-bold">Latest Version Code</label>
                                <input type="number" id="appVersionCode" class="form-control">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="custom-card">
                            <h5 class="text-white mb-3">About Us</h5>
                            <textarea id="aboutText" class="form-control" rows="8"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ADS MANAGER -->
            <div id="section-ads" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="text-white m-0">Ads Manager</h4>
                    <button class="btn btn-primary" id="saveAdsBtn"><i class="fa-solid fa-save"></i> Save</button>
                </div>
                <div class="row g-4">
                    <div class="col-md-12">
                        <div class="custom-card">
                            <div class="d-flex justify-content-between mb-3"><h5 class="text-warning mb-0">Global Script</h5><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="adPopStatus"></div></div>
                            <textarea id="adPopCode" class="form-control"></textarea>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="custom-card">
                            <div class="d-flex justify-content-between mb-3"><h5 class="text-info mb-0">Native Banner</h5><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="adNativeStatus"></div></div>
                            <textarea id="adNativeCode" class="form-control"></textarea>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="custom-card">
                            <div class="d-flex justify-content-between mb-3"><h5 class="text-success mb-0">Sticky Banner</h5><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="adStickyStatus"></div></div>
                            <textarea id="adStickyCode" class="form-control"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CHANNEL MANAGER -->
            <div id="section-channels" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
                    <h4 class="text-white m-0">Channel List</h4>
                    <div class="d-flex gap-2">
                        <select id="channelFilter" class="form-select w-auto"><option value="All">All Categories</option></select>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#channelModal" onclick="resetForm()">Add</button>
                    </div>
                </div>
                <div class="custom-card p-0 overflow-hidden"><table class="table table-dark table-hover mb-0"><tbody id="channelTableBody"></tbody></table></div>
            </div>

            <!-- CHANNEL CATEGORY MANAGER -->
            <div id="section-categories" style="display: none;">
                <h4 class="text-white mb-4">Channel Categories</h4>
                <div class="custom-card">
                    <div class="input-group">
                        <input type="text" id="newCatName" class="form-control" placeholder="Enter Category Name">
                        <button class="btn btn-primary" id="btnAddCat">Add</button>
                    </div>
                </div>
                <div class="custom-card p-0 overflow-hidden"><table class="table table-dark table-hover mb-0"><tbody id="catTableBody"></tbody></table></div>
            </div>

        </div>
    </div>

    <!-- ================= MODALS ================= -->

    <!-- Modal: Add/Edit Match (UPDATED FOR HRS/MINS) -->
    <div class="modal fade" id="matchModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="matchModalTitle">Add New Match</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="matchEditKey">
                    <div class="row g-3">
                        <!-- League Select (Filters Teams) -->
                        <div class="col-md-12">
                            <label class="form-label text-warning">Select Series/League</label>
                            <!-- Note: onchange triggers filtration -->
                            <select class="form-select" id="mSeriesSelect" onchange="filterTeamsByLeague(this.value)">
                                <option value="">Select League...</option>
                            </select>
                        </div>

                        <!-- Team 1 -->
                        <div class="col-md-6">
                            <label class="form-label">Team 1</label>
                            <div class="input-group">
                                <span class="input-group-text bg-dark border-secondary"><img id="mT1Preview" src="" style="width:20px; height:20px; object-fit:contain;"></span>
                                <select class="form-select" id="mT1Select" onchange="updateMatchPreview('1')">
                                    <option value="">Select League First...</option>
                                </select>
                            </div>
                            <input type="hidden" id="mT1Name">
                            <input type="hidden" id="mT1Logo">
                        </div>

                        <!-- Team 2 -->
                        <div class="col-md-6">
                            <label class="form-label">Team 2</label>
                            <div class="input-group">
                                <span class="input-group-text bg-dark border-secondary"><img id="mT2Preview" src="" style="width:20px; height:20px; object-fit:contain;"></span>
                                <select class="form-select" id="mT2Select" onchange="updateMatchPreview('2')">
                                    <option value="">Select League First...</option>
                                </select>
                            </div>
                            <input type="hidden" id="mT2Name">
                            <input type="hidden" id="mT2Logo">
                        </div>
                        
                        <!-- TIME AND DURATION (UPDATED TO HOURS AND MINUTES) -->
                        <div class="col-md-6">
                            <label class="form-label text-info">Match Start Time</label>
                            <input type="datetime-local" class="form-control" id="mStartTime">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-success">Live Duration</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="mDurationHrs" placeholder="Hrs" min="0" value="3">
                                <span class="input-group-text bg-dark text-white">hr</span>
                                <input type="number" class="form-control" id="mDurationMins" placeholder="Min" min="0" max="59" value="0">
                                <span class="input-group-text bg-dark text-white">min</span>
                            </div>
                        </div>

                        <!-- MULTI STREAM LINKS -->
                        <div class="col-md-12">
                            <hr class="border-secondary">
                            <h6 class="text-white mb-3">Stream Links</h6>
                        </div>

                        <!-- Link 1 -->
                        <div class="col-md-12 mb-2">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <label class="form-label text-danger m-0">Server 1 (Main)</label>
                                <select class="form-select form-select-sm w-auto bg-dark text-white border-secondary channel-quick-select" onchange="copyChannelLink('mLink', this.value)">
                                    <option value="">Select from Channel...</option>
                                </select>
                            </div>
                            <input type="text" class="form-control" id="mLink" placeholder="Paste Link 1">
                        </div>

                        <!-- Link 2 -->
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <label class="form-label m-0">Server 2</label>
                                <select class="form-select form-select-sm w-auto bg-dark text-white border-secondary channel-quick-select" onchange="copyChannelLink('mLink2', this.value)">
                                    <option value="">Select...</option>
                                </select>
                            </div>
                            <input type="text" class="form-control" id="mLink2" placeholder="Paste Link 2">
                        </div>

                        <!-- Link 3 -->
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <label class="form-label m-0">Server 3</label>
                                <select class="form-select form-select-sm w-auto bg-dark text-white border-secondary channel-quick-select" onchange="copyChannelLink('mLink3', this.value)">
                                    <option value="">Select...</option>
                                </select>
                            </div>
                            <input type="text" class="form-control" id="mLink3" placeholder="Paste Link 3">
                        </div>

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveMatchBtn">Save Match</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Add/Edit Channel -->
    <div class="modal fade" id="channelModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="chModalTitle">Add New Channel</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="chEditKey">
                    <div class="mb-3"><label class="form-label">Name</label><input type="text" class="form-control" id="chName"></div>
                    <div class="mb-3"><label class="form-label">Category</label><select class="form-select" id="chCat"><option value="">Select...</option></select></div>
                    <div class="mb-3"><label class="form-label">Logo</label><input type="text" class="form-control" id="chLogo"></div>
                    <div class="mb-3"><label class="form-label text-warning">Link 1</label><input type="text" class="form-control" id="chLink"></div>
                    <div class="mb-2"><input type="text" class="form-control mb-2" id="chLink2" placeholder="Link 2 (Optional)"><input type="text" class="form-control" id="chLink3" placeholder="Link 3 (Optional)"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveChannelBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- UI Logic -->
    <script>
        // Mobile Sidebar Toggle
        function toggleMobileSidebar() {
            document.getElementById('sidebar').classList.toggle('mobile-active');
        }
    </script>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getDatabase, ref, push, set, remove, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDwcMREQuQiTDiJ8prnPkNzxV5eq2U097k",
            authDomain: "sportspro-fb7b9.firebaseapp.com",
            databaseURL: "https://sportspro-fb7b9-default-rtdb.firebaseio.com",
            projectId: "sportspro-fb7b9",
            storageBucket: "sportspro-fb7b9.firebasestorage.app",
            messagingSenderId: "752307945154",
            appId: "1:752307945154:web:82510628ecb2f97b96855b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        // ================= AUTHENTICATION LOGIC =================

        const loginSection = document.getElementById('login-section');
        const adminPanel = document.getElementById('admin-panel');
        const btnLogin = document.getElementById('btnLogin');
        const btnLogout = document.getElementById('btnLogout');
        const btnSpinner = document.getElementById('btnSpinner');
        const btnText = document.getElementById('btnText');

        // Check Login State
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginSection.style.display = 'none';
                adminPanel.style.display = 'block';
            } else {
                loginSection.style.display = 'flex';
                adminPanel.style.display = 'none';
            }
        });

        // Login Action
        btnLogin.addEventListener('click', () => {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;

            if(!email || !pass) {
                Swal.fire('Error', 'Please enter email and password', 'error');
                return;
            }

            btnText.style.display = 'none';
            btnSpinner.style.display = 'inline-block';
            btnLogin.disabled = true;

            signInWithEmailAndPassword(auth, email, pass)
                .then((userCredential) => {
                    const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
                    Toast.fire({ icon: 'success', title: 'Signed in successfully' });
                })
                .catch((error) => {
                    Swal.fire('Login Failed', error.message, 'error');
                })
                .finally(() => {
                    btnText.style.display = 'inline-block';
                    btnSpinner.style.display = 'none';
                    btnLogin.disabled = false;
                });
        });

        // Logout Action
        btnLogout.addEventListener('click', () => {
            Swal.fire({
                title: 'Logout?',
                text: "You will be returned to the login screen.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#e50914',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, logout'
            }).then((result) => {
                if (result.isConfirmed) {
                    signOut(auth);
                }
            });
        });

        // ================= END AUTH LOGIC =================

        // Modal Instances
        const channelModal = new bootstrap.Modal(document.getElementById('channelModal'));
        const matchModal = new bootstrap.Modal(document.getElementById('matchModal'));

        // ================= DASHBOARD STATS & GRAPH =================
        onValue(ref(db, 'active_users'), (snapshot) => { document.getElementById('activeUsers').innerText = snapshot.exists() ? snapshot.size : 0; });
        onValue(ref(db, 'channels'), (snapshot) => { document.getElementById('totalChannels').innerText = snapshot.exists() ? snapshot.size : 0; });
        
        let installChartInstance = null;
        onValue(ref(db, 'app_installs'), (snapshot) => {
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            const oneWeekAgo = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7).getTime();
            const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1).getTime();

            let countTotal = 0, countToday = 0, countWeek = 0, countMonth = 0;
            const graphLabels = [];
            const graphData = [0, 0, 0, 0, 0, 0, 0]; 

            for (let i = 6; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth(), now.getDate() - i);
                graphLabels.push(d.toLocaleDateString('en-US', { weekday: 'short' }));
            }

            if(snapshot.exists()) {
                countTotal = snapshot.size;
                snapshot.forEach(child => {
                    const data = child.val();
                    const ts = data.timestamp;
                    if (ts >= todayStart) countToday++;
                    if (ts >= oneWeekAgo) countWeek++;
                    if (ts >= thisMonthStart) countMonth++;
                    const daysDiff = Math.floor((now.getTime() - ts) / (1000 * 60 * 60 * 24));
                    if (daysDiff >= 0 && daysDiff < 7) {
                        graphData[6 - daysDiff]++; 
                    }
                });
            }

            document.getElementById('installTotal').innerText = countTotal;
            document.getElementById('installToday').innerText = countToday;
            document.getElementById('installWeek').innerText = countWeek;
            document.getElementById('installMonth').innerText = countMonth;
            renderChart(graphLabels, graphData);
        });

        function renderChart(labels, data) {
            const ctxCanvas = document.getElementById('installChart');
            if(!ctxCanvas) return;
            const ctx = ctxCanvas.getContext('2d');
            
            if (installChartInstance) installChartInstance.destroy();

            installChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'New Installs',
                        data: data,
                        borderColor: '#e50914',
                        backgroundColor: 'rgba(229, 9, 20, 0.2)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#fff',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#333' }, ticks: { color: '#a0a6b5', stepSize: 1 } },
                        x: { grid: { display: false }, ticks: { color: '#a0a6b5' } }
                    }
                }
            });
        }

        // ================= LEAGUE & TEAM MANAGER =================
        
        // 1. LEAGUE LOGIC
        document.getElementById('btnAddLeague').addEventListener('click', () => {
            const name = document.getElementById('newLeagueName').value;
            if(name) {
                push(ref(db, 'leagues'), { name: name }).then(() => {
                    document.getElementById('newLeagueName').value = '';
                    Swal.fire('Success', 'League Added', 'success');
                });
            }
        });
        
        // Load Leagues into Table & League Dropdowns (Match Modal & Team Manager)
        onValue(ref(db, 'leagues'), (snapshot) => {
            const table = document.getElementById('leagueTableBody');
            const matchSelect = document.getElementById('mSeriesSelect');
            const teamLeagueSelect = document.getElementById('newTeamLeague');
            const teamListFilter = document.getElementById('teamListFilter'); 

            table.innerHTML = '';
            // Reset Selects but keep default option
            matchSelect.innerHTML = '<option value="">Select League...</option>';
            teamLeagueSelect.innerHTML = '<option value="">Select League...</option>';
            teamListFilter.innerHTML = '<option value="All">All Leagues</option>'; // Reset Filter
            
            if(snapshot.exists()) {
                snapshot.forEach(child => {
                    const l = child.val();
                    const key = child.key;
                    
                    // Add to Table
                    table.innerHTML += `
                        <tr>
                            <td class="ps-4">${l.name}</td>
                            <td class="text-end pe-4">
                                <button class="btn btn-sm btn-outline-danger" onclick="window.deleteLeague('${key}')"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>`;
                    
                    // Add to Dropdowns. IMPORTANT: Value is ID, but we save Name attribute to pull text later
                    const opt = `<option value="${key}" data-name="${l.name}">${l.name}</option>`;
                    matchSelect.innerHTML += opt;
                    teamLeagueSelect.innerHTML += opt;
                    teamListFilter.innerHTML += opt; // Populate Filter
                });
            }
        });
        window.deleteLeague = (key) => remove(ref(db, 'leagues/' + key));

        // 2. TEAM LOGIC (UPDATED WITH FILTERING)
        window.allTeams = []; // Cache for filtering logic
        
        document.getElementById('btnAddTeam').addEventListener('click', () => {
            const leagueId = document.getElementById('newTeamLeague').value;
            const name = document.getElementById('newTeamName').value;
            const logo = document.getElementById('newTeamLogo').value;

            if(name && leagueId) {
                // Save team WITH leagueId
                push(ref(db, 'teams'), { name: name, logo: logo, leagueId: leagueId }).then(() => {
                    document.getElementById('newTeamName').value = '';
                    document.getElementById('newTeamLogo').value = '';
                    Swal.fire('Success', 'Team Added', 'success');
                });
            } else {
                Swal.fire('Error', 'Please select a League and enter Team Name', 'error');
            }
        });

        // Load Teams into Cache Only (Rendering handled by function)
        onValue(ref(db, 'teams'), (snapshot) => {
            window.allTeams = [];
            if(snapshot.exists()) {
                snapshot.forEach(child => {
                    const t = child.val();
                    const key = child.key;
                    window.allTeams.push({key: key, ...t});
                });
            }
            // Trigger initial render
            window.renderTeamTable(); 
        });

        // NEW: Render Team Table based on Filter
        window.renderTeamTable = () => {
            const table = document.getElementById('teamTableBody');
            const filterValue = document.getElementById('teamListFilter').value;
            table.innerHTML = '';

            let teamsToShow = window.allTeams;
            
            // Filter if not "All"
            if (filterValue !== "All") {
                teamsToShow = window.allTeams.filter(t => t.leagueId === filterValue);
            }

            if (teamsToShow.length === 0) {
                table.innerHTML = `<tr><td colspan="4" class="text-center text-secondary">No teams found for selected league.</td></tr>`;
                return;
            }

            teamsToShow.forEach(t => {
                table.innerHTML += `
                    <tr>
                        <td class="ps-4"><img src="${t.logo}" class="team-logo-sm" onerror="this.src='https://via.placeholder.com/30'"></td>
                        <td>${t.name}</td>
                        <td class="text-secondary small">${t.leagueId || '-'}</td>
                        <td class="text-end pe-4">
                            <button class="btn btn-sm btn-outline-danger" onclick="window.deleteTeam('${t.key}')"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        };

        window.deleteTeam = (key) => remove(ref(db, 'teams/' + key));


        // ================= MATCH MANAGER (DEPENDENT DROPDOWN LOGIC) =================
        
        // 1. FILTER TEAMS WHEN LEAGUE IS SELECTED
        window.filterTeamsByLeague = (leagueId) => {
            const select1 = document.getElementById('mT1Select');
            const select2 = document.getElementById('mT2Select');
            
            // Clear current options
            select1.innerHTML = '<option value="">Select Team...</option>';
            select2.innerHTML = '<option value="">Select Team...</option>';
            
            // Clear Previews
            document.getElementById('mT1Preview').src = "";
            document.getElementById('mT2Preview').src = "";

            if (!leagueId) return;

            // Filter Global Teams Cache
            const filteredTeams = window.allTeams.filter(t => t.leagueId === leagueId);

            if(filteredTeams.length === 0) {
                const opt = '<option value="">No teams in this league</option>';
                select1.innerHTML = opt;
                select2.innerHTML = opt;
            } else {
                filteredTeams.forEach(t => {
                    const opt = `<option value="${t.key}">${t.name}</option>`;
                    select1.innerHTML += opt;
                    select2.innerHTML += opt;
                });
            }
        };

        // 2. MATCH MANAGER LOGIC
        window.allMatches = [];
        onValue(ref(db, 'matches'), (snapshot) => {
            const tbody = document.getElementById('matchTableBody');
            window.allMatches = []; 
            const now = Date.now();

            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    window.allMatches.push({ key: child.key, ...child.val() });
                });
                
                window.allMatches.sort((a, b) => (Number(b.startTime) || 0) - (Number(a.startTime) || 0));

                let tableHtml = '';

                window.allMatches.forEach(m => {
                    const start = Number(m.startTime) || 0;
                    const end = Number(m.endTime) || (start + (3 * 3600000));
                    
                    let statusBadge = '';
                    let rowClass = '';

                    if (now > end) {
                        statusBadge = '<span class="badge bg-danger">EXPIRED</span>';
                        rowClass = 'expired-row';
                    } else if (now >= start && now <= end) {
                        statusBadge = '<span class="badge bg-success">LIVE NOW</span>';
                    } else {
                        statusBadge = '<span class="badge bg-warning text-dark">UPCOMING</span>';
                    }

                    const startDate = start ? new Date(start).toLocaleString() : 'N/A';
                    
                    // Display friendly duration
                    const diffMs = end - start;
                    const hrs = Math.floor(diffMs / 3600000);
                    const mins = Math.round((diffMs % 3600000) / 60000);
                    const durationStr = `${hrs}h ${mins}m`;

                    tableHtml += `
                        <tr class="${rowClass}">
                            <td class="ps-4">${statusBadge}</td>
                            <td class="text-white">${m.series || 'N/A'}</td>
                            <td>
                                <div class="d-flex align-items-center gap-2 text-white">
                                    <img src="${m.team1_logo}" class="team-logo-sm" onerror="this.src='https://via.placeholder.com/30'">
                                    ${m.team1_name}
                                    <span class="text-secondary mx-1">VS</span>
                                    <img src="${m.team2_logo}" class="team-logo-sm" onerror="this.src='https://via.placeholder.com/30'">
                                    ${m.team2_name}
                                </div>
                            </td>
                            <td class="text-secondary">${startDate}</td>
                            <td class="text-white">${durationStr}</td>
                            <td class="text-end pe-4">
                                <button class="btn btn-sm btn-outline-info me-2" onclick="window.editMatch('${m.key}')"><i class="fa-solid fa-pen"></i></button>
                                <button class="btn btn-sm btn-outline-danger" onclick="window.deleteMatch('${m.key}')"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = tableHtml;

            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-secondary py-3">No matches found</td></tr>';
            }
        });

        // MATCH MODAL HELPER: Auto-fill Logo when Team is Selected
        window.updateMatchPreview = (num) => {
            const select = document.getElementById(`mT${num}Select`);
            const preview = document.getElementById(`mT${num}Preview`);
            const nameInput = document.getElementById(`mT${num}Name`);
            const logoInput = document.getElementById(`mT${num}Logo`);
            
            const teamKey = select.value;
            const team = window.allTeams.find(t => t.key === teamKey);

            if(team) {
                preview.src = team.logo;
                nameInput.value = team.name;
                logoInput.value = team.logo;
            } else {
                preview.src = "";
                nameInput.value = "";
                logoInput.value = "";
            }
        };

        // MATCH MODAL HELPER: Copy Channel Link (Generic for 3 Links)
        window.copyChannelLink = (inputId, url) => {
            if(url) document.getElementById(inputId).value = url;
        };

        // Save Match
        document.getElementById('saveMatchBtn').addEventListener('click', () => {
            const key = document.getElementById('matchEditKey').value;
            
            const seriesSelect = document.getElementById('mSeriesSelect');
            // Get League ID for data logic if needed, but we save Name for Display
            const seriesId = seriesSelect.value;
            const seriesName = seriesSelect.options[seriesSelect.selectedIndex].getAttribute('data-name') || seriesSelect.value;
            
            const t1 = document.getElementById('mT1Name').value;
            const l1 = document.getElementById('mT1Logo').value;
            const t2 = document.getElementById('mT2Name').value;
            const l2 = document.getElementById('mT2Logo').value;
            
            const link = document.getElementById('mLink').value;
            const link2 = document.getElementById('mLink2').value;
            const link3 = document.getElementById('mLink3').value;
            const startStr = document.getElementById('mStartTime').value;
            
            // UPDATED: Use Hours and Minutes inputs
            const durHrs = parseInt(document.getElementById('mDurationHrs').value) || 0;
            const durMins = parseInt(document.getElementById('mDurationMins').value) || 0;

            if (!t1 || !t2 || !startStr || !link) {
                return Swal.fire('Error', 'Teams, Start Time and Main Link are required!', 'error');
            }
            
            if (durHrs === 0 && durMins === 0) {
                 return Swal.fire('Error', 'Please set a duration greater than 0.', 'error');
            }

            const startTime = new Date(startStr).getTime();
            // Calculate End Time based on Hrs + Mins
            const totalDurationMs = (durHrs * 3600000) + (durMins * 60000);
            const endTime = startTime + totalDurationMs; 
            
            const name = `${t1} vs ${t2}`;

            const data = {
                name: name,
                series: seriesName, // Saving Name, not ID
                leagueId: seriesId, // Optional: Saving ID for future ref
                team1_name: t1, team1_logo: l1,
                team2_name: t2, team2_logo: l2,
                link: link,
                link2: link2,
                link3: link3,
                startTime: startTime,
                endTime: endTime
            };

            if (key) {
                update(ref(db, 'matches/' + key), data).then(() => {
                    Swal.fire('Updated', 'Match updated successfully', 'success');
                    matchModal.hide();
                });
            } else {
                push(ref(db, 'matches'), data).then(() => {
                    Swal.fire('Added', 'Match added successfully', 'success');
                    matchModal.hide();
                });
            }
        });

        // Edit Match Helper
        window.editMatch = (key) => {
            const m = window.allMatches.find(x => x.key === key);
            if (!m) return;
            
            document.getElementById('matchEditKey').value = key;

            // Logic to restore state (Bit complex due to dynamic dependent dropdowns)
            
            // 1. Set League/Series Dropdown
            const leagueSelect = document.getElementById('mSeriesSelect');
            // Try to find option by ID (if m.leagueId exists) or Name
            let leagueOption = null;
            if(m.leagueId) {
                leagueSelect.value = m.leagueId;
            } else {
                // Fallback: Loop to find option with text matching series name
                for (let i = 0; i < leagueSelect.options.length; i++) {
                    if (leagueSelect.options[i].text === m.series) {
                        leagueSelect.selectedIndex = i;
                        break;
                    }
                }
            }

            // 2. Trigger Filter Logic Immediately so Team Options appear
            window.filterTeamsByLeague(leagueSelect.value);
            
            // 3. Select Teams (Find by Name since ID might change if re-added)
            const t1Obj = window.allTeams.find(t => t.name === m.team1_name);
            const t2Obj = window.allTeams.find(t => t.name === m.team2_name);
            
            document.getElementById('mT1Select').value = t1Obj ? t1Obj.key : "";
            document.getElementById('mT2Select').value = t2Obj ? t2Obj.key : "";
            
            // 4. Fill Hidden/Visuals
            document.getElementById('mT1Name').value = m.team1_name;
            document.getElementById('mT1Logo').value = m.team1_logo;
            document.getElementById('mT1Preview').src = m.team1_logo;
            
            document.getElementById('mT2Name').value = m.team2_name;
            document.getElementById('mT2Logo').value = m.team2_logo;
            document.getElementById('mT2Preview').src = m.team2_logo;

            document.getElementById('mLink').value = m.link;
            document.getElementById('mLink2').value = m.link2 || "";
            document.getElementById('mLink3').value = m.link3 || "";

            if(m.startTime) {
                const d = new Date(m.startTime);
                // Trick to get local time into datetime-local input
                const localISOTime = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                document.getElementById('mStartTime').value = localISOTime;
            }

            // UPDATED: Calculate Hours and Minutes from start/end diff
            if(m.endTime && m.startTime) {
                const diffMs = m.endTime - m.startTime;
                const hrs = Math.floor(diffMs / 3600000);
                const mins = Math.round((diffMs % 3600000) / 60000);
                document.getElementById('mDurationHrs').value = hrs;
                document.getElementById('mDurationMins').value = mins;
            } else {
                document.getElementById('mDurationHrs').value = 3;
                document.getElementById('mDurationMins').value = 0;
            }

            document.getElementById('matchModalTitle').innerText = "Edit Match";
            matchModal.show();
        };

        window.deleteMatch = (key) => {
            Swal.fire({ title: 'Delete Match?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' }).then((res) => {
                if (res.isConfirmed) remove(ref(db, 'matches/' + key));
            });
        };

        window.clearExpiredMatches = () => {
            const now = Date.now();
            let toDelete = [];
            window.allMatches.forEach(m => {
                if (m.endTime < now) toDelete.push(m.key);
            });

            if (toDelete.length === 0) return Swal.fire('Info', 'No expired matches found.', 'info');

            Swal.fire({
                title: `Delete ${toDelete.length} Expired Matches?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Yes, Delete All'
            }).then((res) => {
                if (res.isConfirmed) {
                    toDelete.forEach(k => remove(ref(db, 'matches/' + k)));
                    Swal.fire('Deleted!', 'Expired matches removed.', 'success');
                }
            });
        };

        window.resetMatchForm = () => {
            document.getElementById('matchEditKey').value = "";
            document.getElementById('mSeriesSelect').value = "";
            document.getElementById('mT1Select').innerHTML = '<option value="">Select League First...</option>';
            document.getElementById('mT2Select').innerHTML = '<option value="">Select League First...</option>';
            document.getElementById('mT1Preview').src = "";
            document.getElementById('mT2Preview').src = "";
            document.getElementById('mT1Name').value = "";
            document.getElementById('mT1Logo').value = "";
            document.getElementById('mT2Name').value = "";
            document.getElementById('mT2Logo').value = "";
            
            document.getElementById('mLink').value = "";
            document.getElementById('mLink2').value = "";
            document.getElementById('mLink3').value = "";
            document.getElementById('mStartTime').value = "";
            // Reset to defaults
            document.getElementById('mDurationHrs').value = "3";
            document.getElementById('mDurationMins').value = "0";
            document.getElementById('matchModalTitle').innerText = "Add New Match";
            
            // Reset channel quick selects
            document.querySelectorAll('.channel-quick-select').forEach(el => el.value = "");
        };

        // ================= APP SETTINGS =================
        const settingsRef = ref(db, 'app_settings');
        onValue(settingsRef, (snap) => {
            if(snap.exists()) {
                const data = snap.val();
                document.getElementById('requestUrl').value = data.request_url || '';
                document.getElementById('shareUrl').value = data.share_url || '';
                document.getElementById('updateUrl').value = data.update_url || '';
                document.getElementById('aboutText').value = data.about_text || '';
                document.getElementById('appVersionCode').value = data.latest_version_code || '1';
            }
        });
        document.getElementById('saveSettingsBtn').addEventListener('click', () => { 
            update(settingsRef, { 
                request_url: document.getElementById('requestUrl').value, 
                share_url: document.getElementById('shareUrl').value, 
                update_url: document.getElementById('updateUrl').value, 
                about_text: document.getElementById('aboutText').value,
                latest_version_code: parseInt(document.getElementById('appVersionCode').value) || 1
            }).then(() => { Swal.fire('Saved!', 'Settings updated.', 'success'); }); 
        });

        // ================= ADS MANAGER =================
        const adsRef = ref(db, 'app_settings/ads');
        onValue(adsRef, (snapshot) => {
            if(snapshot.exists()) {
                const ads = snapshot.val();
                document.getElementById('adPopCode').value = ads.popunder?.code || '';
                document.getElementById('adPopStatus').checked = ads.popunder?.active || false;
                document.getElementById('adNativeCode').value = ads.native?.code || '';
                document.getElementById('adNativeStatus').checked = ads.native?.active || false;
                document.getElementById('adStickyCode').value = ads.sticky?.code || '';
                document.getElementById('adStickyStatus').checked = ads.sticky?.active || false;
            }
        });
        document.getElementById('saveAdsBtn').addEventListener('click', () => {
            const adsData = { popunder: { code: document.getElementById('adPopCode').value, active: document.getElementById('adPopStatus').checked }, native: { code: document.getElementById('adNativeCode').value, active: document.getElementById('adNativeStatus').checked }, sticky: { code: document.getElementById('adStickyCode').value, active: document.getElementById('adStickyStatus').checked } };
            set(adsRef, adsData).then(() => Swal.fire('Saved!', 'Ad settings updated.', 'success'));
        });

        // ================= CHANNELS =================
        window.allChannelsData = [];
        document.getElementById('channelFilter').addEventListener('change', function() { renderChannelTable(this.value); });
        function renderChannelTable(filterCat = "All") { const tbody = document.getElementById('channelTableBody'); tbody.innerHTML = ''; let displayData = window.allChannelsData; if(filterCat !== "All") { displayData = window.allChannelsData.filter(ch => ch.category === filterCat); } displayData.forEach(v => { tbody.innerHTML += `<tr data-id="${v.key}" class="draggable-row"><td class="ps-4 text-secondary"><i class="fa-solid fa-bars" style="cursor: grab;"></i></td><td class="ps-2"><img src="${v.logo}" class="channel-img-preview" onerror="this.src='https://via.placeholder.com/40'"></td><td class="text-white fw-bold">${v.name}</td><td><span class="badge bg-secondary">${v.category}</span></td><td class="text-end pe-4"><button class="btn btn-sm btn-outline-info me-2" onclick="window.editChannel('${v.key}', '${v.name}', '${v.logo}', '${v.category}', '${v.link}', '${v.link2 || ''}', '${v.link3 || ''}')"><i class="fa-solid fa-pen"></i></button><button class="btn btn-sm btn-outline-danger" onclick="window.deleteChannel('${v.key}')"><i class="fa-solid fa-trash"></i></button></td></tr>`; }); }
        onValue(ref(db, 'channels'), (snapshot) => { 
            let count = 0; 
            window.allChannelsData = []; 
            const channelSelects = document.querySelectorAll('.channel-quick-select');
            
            // Clear Selects
            channelSelects.forEach(sel => sel.innerHTML = '<option value="">Select...</option>');

            if(snapshot.exists()) { 
                snapshot.forEach((child) => { 
                    const data = {key: child.key, ...child.val()};
                    window.allChannelsData.push(data);
                    
                    // Populate ALL Channel Selects in Match Modal
                    const opt = `<option value="${data.link}">${data.name}</option>`;
                    channelSelects.forEach(sel => sel.innerHTML += opt);
                }); 
                window.allChannelsData.sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0)); 
                count = window.allChannelsData.length; 
            } 
            document.getElementById('totalChannels').innerText = count; 
            renderChannelTable(document.getElementById('channelFilter').value); 
        });

        document.getElementById('saveChannelBtn').addEventListener('click', () => { const key = document.getElementById('chEditKey').value; const data = { name: document.getElementById('chName').value, category: document.getElementById('chCat').value, logo: document.getElementById('chLogo').value, link: document.getElementById('chLink').value, link2: document.getElementById('chLink2').value, link3: document.getElementById('chLink3').value, sortOrder: key ? undefined : 9999 }; if(key) delete data.sortOrder; if(!data.name || !data.link) { Swal.fire('Error', 'Data missing!', 'error'); return; } if(key) { update(ref(db, 'channels/' + key), data).then(() => { Swal.fire('Success', 'Updated', 'success'); channelModal.hide(); }); } else { push(ref(db, 'channels'), data).then(() => { Swal.fire('Success', 'Added', 'success'); channelModal.hide(); }); } });
        new Sortable(document.getElementById('channelTableBody'), { animation: 150, handle: '.fa-bars', onEnd: function (evt) { document.querySelectorAll('#channelTableBody tr').forEach((row, index) => { update(ref(db, 'channels/' + row.getAttribute('data-id')), { sortOrder: index }); }); } });
        window.editChannel = function(key, name, logo, cat, link, link2, link3) { document.getElementById('chEditKey').value = key; document.getElementById('chName').value = name; document.getElementById('chLogo').value = logo; document.getElementById('chCat').value = cat; document.getElementById('chLink').value = link; document.getElementById('chLink2').value = link2; document.getElementById('chLink3').value = link3; document.getElementById('chModalTitle').innerText = "Edit Channel"; channelModal.show(); }
        window.deleteChannel = function(key) { Swal.fire({ title: 'Delete?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' }).then((res) => { if (res.isConfirmed) remove(ref(db, 'channels/' + key)); }); }
        window.resetForm = function() { document.getElementById('chEditKey').value = ""; document.getElementById('chName').value = ""; document.getElementById('chLogo').value = ""; const filterVal = document.getElementById('channelFilter').value; document.getElementById('chCat').value = filterVal === "All" ? "" : filterVal; document.getElementById('chLink').value = ""; document.getElementById('chLink2').value = ""; document.getElementById('chLink3').value = ""; document.getElementById('chModalTitle').innerText = "Add New Channel"; }

        // ================= CATEGORIES =================
        new Sortable(document.getElementById('catTableBody'), { animation: 150, handle: '.fa-bars', onEnd: function (evt) { document.querySelectorAll('#catTableBody tr').forEach((row, index) => { update(ref(db, 'categories/' + row.getAttribute('data-id')), { sortOrder: index }); }); } });
        document.getElementById('btnAddCat').addEventListener('click', () => { const catName = document.getElementById('newCatName').value; if(catName) { push(ref(db, 'categories'), { name: catName, sortOrder: 9999 }).then(() => { Swal.fire('Success', 'Category Added!', 'success'); document.getElementById('newCatName').value = ''; }); } });
        window.editCat = async function(key, oldName) { const { value: newName } = await Swal.fire({ title: 'Rename Category', input: 'text', inputValue: oldName, showCancelButton: true }); if (newName && newName !== oldName) { update(ref(db, 'categories/' + key), { name: newName }); } };
        onValue(ref(db, 'categories'), (snapshot) => { const tbody = document.getElementById('catTableBody'); const dropdown = document.getElementById('chCat'); const filterDropdown = document.getElementById('channelFilter'); tbody.innerHTML = ''; dropdown.innerHTML = '<option value="">Select Category...</option>'; const currentFilter = filterDropdown.value; filterDropdown.innerHTML = '<option value="All">All Categories</option>'; if(snapshot.exists()) { const catArr = []; snapshot.forEach((child) => { catArr.push({key: child.key, ...child.val()}); }); catArr.sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0)); catArr.forEach(v => { tbody.innerHTML += `<tr data-id="${v.key}" class="draggable-row"><td class="ps-4 text-secondary"><i class="fa-solid fa-bars" style="cursor: grab;"></i></td><td>${v.name}</td><td class="text-end pe-4"><button class="btn btn-sm btn-outline-warning me-2" onclick="window.editCat('${v.key}', '${v.name}')"><i class="fa-solid fa-pen"></i></button><button class="btn btn-sm btn-outline-danger" onclick="window.deleteCat('${v.key}')"><i class="fa-solid fa-trash"></i></button></td></tr>`; dropdown.innerHTML += `<option value="${v.name}">${v.name}</option>`; filterDropdown.innerHTML += `<option value="${v.name}">${v.name}</option>`; }); } filterDropdown.value = currentFilter; });
        window.deleteCat = function(key) { remove(ref(db, 'categories/' + key)); }

        // Section Switcher
        window.showSection = function(id, element) {
            // Hide all sections
            ['dashboard', 'settings', 'ads', 'categories', 'channels', 'matches', 'teams'].forEach(sec => {
                const el = document.getElementById('section-' + sec);
                if(el) el.style.display = 'none';
            });
            // Show selected
            const target = document.getElementById('section-' + id);
            if(target) target.style.display = 'block';
            
            // Activate Nav
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            if(element) element.classList.add('active');
            
            // Auto close mobile sidebar
            document.getElementById('sidebar').classList.remove('mobile-active');
        }
    </script>
</body>
</html>
