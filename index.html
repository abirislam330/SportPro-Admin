<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SportsPro Admin Console</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 (Popups) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- SortableJS (Drag & Drop) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        :root {
            --bg-dark: #0f111a;
            --sidebar-bg: #151823;
            --card-bg: #1e212d;
            --primary-color: #e50914;
            --text-color: #a0a6b5;
        }

        body { background-color: var(--bg-dark); color: var(--text-color); font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }

        /* Sidebar Styles */
        .sidebar {
            width: 260px; height: 100vh; background-color: var(--sidebar-bg);
            position: fixed; top: 0; left: 0; padding: 20px;
            border-right: 1px solid #2a2d3a; z-index: 1000;
        }
        .brand-logo { font-size: 24px; font-weight: 800; color: white; margin-bottom: 40px; }
        .brand-logo span { color: var(--primary-color); font-style: italic; }
        .nav-link {
            color: var(--text-color); padding: 12px 15px; border-radius: 8px; margin-bottom: 5px;
            transition: all 0.3s; display: flex; align-items: center; gap: 12px; text-decoration: none; font-weight: 500; cursor: pointer;
        }
        .nav-link:hover, .nav-link.active { background-color: rgba(229, 9, 20, 0.15); color: var(--primary-color); }
        .nav-link i { width: 20px; text-align: center; }

        /* Main Content */
        .main-content { margin-left: 260px; padding: 30px; }

        /* Cards */
        .custom-card { background-color: var(--card-bg); border-radius: 12px; padding: 20px; border: 1px solid #2a2d3a; margin-bottom: 20px; height: 100%; }
        .stats-info h3 { font-size: 28px; color: white; margin: 0; font-weight: 700; }
        
        /* Tables */
        .table-dark { --bs-table-bg: transparent; --bs-table-color: var(--text-color); --bs-table-border-color: #2a2d3a; }
        .table-dark th { color: #fff; font-weight: 600; text-transform: uppercase; font-size: 12px; }
        .table-dark td { vertical-align: middle; }
        .draggable-row { cursor: grab; }
        .draggable-row:active { cursor: grabbing; background-color: #2a2d3a; }
        .channel-img-preview { width: 50px; height: 50px; object-fit: contain; background: #fff; padding: 2px; border-radius: 4px; }
        .banner-img-preview { width: 120px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #333; }

        /* Forms */
        .form-control, .form-select { background-color: #151823; border: 1px solid #333; color: white; }
        .form-control:focus, .form-select:focus { background-color: #151823; border-color: var(--primary-color); color: white; box-shadow: none; }
        textarea.form-control { min-height: 100px; font-family: monospace; font-size: 13px; color: #fff; }

        /* Modal */
        .modal-content { background-color: var(--card-bg); color: white; border: 1px solid #333; }
        .modal-header, .modal-footer { border-color: #333; }
        .btn-primary { background-color: var(--primary-color); border: none; }
        .btn-primary:hover { background-color: #c40812; }
    </style>
</head>
<body>

    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="brand-logo"><i class="fa-solid fa-play-circle"></i> Sports<span>Pro</span></div>
        <nav class="nav flex-column">
            <div class="nav-link active" onclick="showSection('dashboard')">
                <i class="fa-solid fa-chart-pie"></i> Dashboard
            </div>
            
            <!-- NEW: Banners Section -->
            <div class="nav-link" onclick="showSection('banners')">
                <i class="fa-solid fa-images"></i> Home Sliders
            </div>

            <div class="nav-link" onclick="showSection('leagues')">
                <i class="fa-solid fa-trophy"></i> Manage Leagues
            </div>
             <div class="nav-link" onclick="showSection('league-cats')">
                <i class="fa-solid fa-list"></i> League Categories
            </div>
            <div class="nav-link" onclick="showSection('channels')">
                <i class="fa-solid fa-tv"></i> Manage Channels
            </div>
            <div class="nav-link" onclick="showSection('categories')">
                <i class="fa-solid fa-tags"></i> Channel Categories
            </div>

            <div class="nav-link" onclick="showSection('settings')">
                <i class="fa-solid fa-gear"></i> App Settings
            </div>
            <div class="nav-link" onclick="showSection('ads')">
                <i class="fa-solid fa-rectangle-ad"></i> Ads Manager
            </div>
        </nav>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        
        <!-- 1. DASHBOARD SECTION -->
        <div id="section-dashboard">
            <h4 class="text-white mb-4">Dashboard Overview</h4>
            <div class="row g-4">
                <div class="col-md-3">
                    <div class="custom-card d-flex justify-content-between align-items-center" style="border-color: #00ff9d;">
                        <div class="stats-info">
                            <h3 id="activeUsers" class="text-success">0</h3>
                            <p class="m-0 text-white">Active Users</p>
                        </div>
                        <div class="spinner-grow text-success" role="status" style="width: 2rem; height: 2rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="custom-card d-flex justify-content-between align-items-center">
                        <div class="stats-info">
                            <h3 id="totalLeagues">0</h3>
                            <p class="m-0">Total Leagues</p>
                        </div>
                        <i class="fa-solid fa-trophy fs-2 text-warning"></i>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="custom-card d-flex justify-content-between align-items-center">
                        <div class="stats-info">
                            <h3 id="totalChannels">0</h3>
                            <p class="m-0">Total Channels</p>
                        </div>
                        <i class="fa-solid fa-tv fs-2 text-danger"></i>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="custom-card d-flex justify-content-between align-items-center">
                        <div class="stats-info">
                            <h3 id="totalBanners">0</h3>
                            <p class="m-0">Active Sliders</p>
                        </div>
                        <i class="fa-solid fa-images fs-2 text-primary"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. SLIDER / BANNER MANAGER (NEW) -->
        <div id="section-banners" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h4 class="text-white m-0">Home Slider Manager</h4>
                    <small class="text-secondary">Banners shown at the top of the app.</small>
                </div>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#bannerModal" onclick="resetBannerForm()">
                    <i class="fa-solid fa-plus"></i> Add Slider
                </button>
            </div>

            <div class="custom-card p-0 overflow-hidden">
                <table class="table table-dark table-hover mb-0">
                    <thead>
                        <tr>
                            <th class="ps-4" style="width: 50px;">Sort</th>
                            <th class="ps-2">Banner Image</th>
                            <th>Description (Optional)</th>
                            <th>Action Link</th>
                            <th class="text-end pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="bannerTableBody">
                        <!-- Banner Data will load here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 3. LEAGUE MANAGER SECTION (UPDATED) -->
        <div id="section-leagues" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h4 class="text-white m-0">League Manager</h4>
                    <small class="text-secondary">Drag rows to reorder leagues.</small>
                </div>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#leagueModal" onclick="resetLeagueForm()">
                    <i class="fa-solid fa-plus"></i> Add League
                </button>
            </div>

            <div class="custom-card p-0 overflow-hidden">
                <table class="table table-dark table-hover mb-0">
                    <thead>
                        <tr>
                            <th class="ps-4" style="width: 50px;">Sort</th>
                            <th class="ps-2">Logo</th>
                            <th>League Name</th>
                            <th>Category</th>
                            <th>Stream Link</th>
                            <th class="text-end pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="leagueTableBody">
                        <!-- League Data will load here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 4. APP SETTINGS SECTION -->
        <div id="section-settings" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h4 class="text-white m-0">App Configuration</h4>
                </div>
                <button class="btn btn-primary" id="saveSettingsBtn"><i class="fa-solid fa-save"></i> Save</button>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="custom-card">
                        <h5 class="text-white mb-3">App Links</h5>
                        <div class="mb-4">
                            <label class="form-label text-warning">Channel Request Link</label>
                            <input type="text" id="requestUrl" class="form-control" placeholder="https://t.me/...">
                        </div>
                        <div class="mb-2">
                            <label class="form-label text-success">Share App Link</label>
                            <input type="text" id="shareUrl" class="form-control" placeholder="https://play.google.com/...">
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="custom-card">
                        <h5 class="text-white mb-3">About Us</h5>
                        <textarea id="aboutText" class="form-control" rows="8"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. ADS MANAGER SECTION -->
        <div id="section-ads" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div><h4 class="text-white m-0">Ads Manager</h4></div>
                <button class="btn btn-primary" id="saveAdsBtn"><i class="fa-solid fa-save"></i> Save</button>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="custom-card">
                        <div class="d-flex justify-content-between mb-3">
                            <h5 class="text-warning mb-0">Global Script / Popunder</h5>
                            <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="adPopStatus"><label class="form-check-label text-white" for="adPopStatus">Enable</label></div>
                        </div>
                        <textarea id="adPopCode" class="form-control" placeholder="<script>...</script>"></textarea>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="custom-card">
                        <div class="d-flex justify-content-between mb-3">
                            <h5 class="text-info mb-0">Native Banner</h5>
                            <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="adNativeStatus"><label class="form-check-label text-white" for="adNativeStatus">Enable</label></div>
                        </div>
                        <textarea id="adNativeCode" class="form-control" placeholder="<script>...</script>"></textarea>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="custom-card">
                        <div class="d-flex justify-content-between mb-3">
                            <h5 class="text-success mb-0">Sticky Banner</h5>
                            <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="adStickyStatus"><label class="form-check-label text-white" for="adStickyStatus">Enable</label></div>
                        </div>
                        <textarea id="adStickyCode" class="form-control" placeholder="<script>...</script>"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- 6. LEAGUE CATEGORY MANAGER -->
        <div id="section-league-cats" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="text-white m-0">League Categories</h4>
            </div>
            <div class="custom-card">
                <div class="input-group">
                    <input type="text" id="newLgCatName" class="form-control" placeholder="Enter Category Name">
                    <button class="btn btn-primary" id="btnAddLgCat"><i class="fa-solid fa-plus"></i> Add</button>
                </div>
            </div>
            <div class="custom-card p-0 overflow-hidden">
                <table class="table table-dark table-hover mb-0">
                    <tbody id="lgCatTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- 7. CHANNEL MANAGER & CATS -->
        <div id="section-channels" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="text-white m-0">Channel List</h4>
                <div class="d-flex gap-2">
                    <select id="channelFilter" class="form-select w-auto"><option value="All">All Categories</option></select>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#channelModal" onclick="resetForm()"><i class="fa-solid fa-plus"></i> Add</button>
                </div>
            </div>
            <div class="custom-card p-0 overflow-hidden">
                <table class="table table-dark table-hover mb-0">
                    <tbody id="channelTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="section-categories" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4"><h4 class="text-white m-0">Channel Categories</h4></div>
            <div class="custom-card">
                <div class="input-group">
                    <input type="text" id="newCatName" class="form-control" placeholder="Enter Category Name">
                    <button class="btn btn-primary" id="btnAddCat"><i class="fa-solid fa-plus"></i> Add</button>
                </div>
            </div>
            <div class="custom-card p-0 overflow-hidden">
                <table class="table table-dark table-hover mb-0"><tbody id="catTableBody"></tbody></table>
            </div>
        </div>

    </div>

    <!-- ================= MODALS ================= -->

    <!-- Modal: Add/Edit Banner (NEW) -->
    <div class="modal fade" id="bannerModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bnrModalTitle">Add New Slider</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="bnrEditKey">
                    
                    <div class="mb-3">
                        <label class="form-label text-warning">Image URL (Landscape)</label>
                        <input type="text" class="form-control" id="bnrImage" placeholder="https://...">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Action/Stream Link</label>
                        <input type="text" class="form-control" id="bnrLink" placeholder="http://example.com/live.m3u8">
                        <small class="text-secondary">What happens when user clicks the banner?</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Title / Description (Optional)</label>
                        <input type="text" class="form-control" id="bnrTitle" placeholder="e.g. Big Match Tonight">
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveBannerBtn">Save Slider</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Add/Edit League (UPDATED - No Banner Options) -->
    <div class="modal fade" id="leagueModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="lgModalTitle">Add New League</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="lgEditKey">
                    
                    <div class="mb-3">
                        <label class="form-label">League Name</label>
                        <input type="text" class="form-control" id="lgName">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="lgCat">
                            <option value="">Select Category...</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">League Logo URL (Icon)</label>
                        <input type="text" class="form-control" id="lgLogo">
                    </div>

                    <hr class="border-secondary">
                    
                    <div class="mb-3">
                        <label class="form-label text-warning">Live Stream URL</label>
                        <input type="text" class="form-control" id="lgSource1" placeholder="http://...">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Optional Links</label>
                        <input type="text" class="form-control form-control-sm mb-2" id="lgLink2" placeholder="Backup Link 2">
                        <input type="text" class="form-control form-control-sm" id="lgLink3" placeholder="Backup Link 3">
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveLeagueBtn">Save League</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Add/Edit Channel -->
    <div class="modal fade" id="channelModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="chModalTitle">Add New Channel</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="chEditKey">
                    <div class="mb-3"><label class="form-label">Channel Name</label><input type="text" class="form-control" id="chName"></div>
                    <div class="mb-3"><label class="form-label">Category</label><select class="form-select" id="chCat"><option value="">Select Category...</option></select></div>
                    <div class="mb-3"><label class="form-label">Logo URL</label><input type="text" class="form-control" id="chLogo"></div>
                    <hr class="border-secondary">
                    <div class="mb-3"><label class="form-label text-warning">Server 1 (Main)</label><input type="text" class="form-control" id="chLink" placeholder="http://..."></div>
                    <div class="mb-2"><input type="text" class="form-control mb-2" id="chLink2" placeholder="Server 2"><input type="text" class="form-control" id="chLink3" placeholder="Server 3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveChannelBtn">Save Channel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getDatabase, ref, push, set, remove, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

        // --- YOUR FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDwcMREQuQiTDiJ8prnPkNzxV5eq2U097k",
            authDomain: "sportspro-fb7b9.firebaseapp.com",
            databaseURL: "https://sportspro-fb7b9-default-rtdb.firebaseio.com",
            projectId: "sportspro-fb7b9",
            storageBucket: "sportspro-fb7b9.firebasestorage.app",
            messagingSenderId: "752307945154",
            appId: "1:752307945154:web:82510628ecb2f97b96855b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // Modal Instances
        const channelModal = new bootstrap.Modal(document.getElementById('channelModal'));
        const leagueModal = new bootstrap.Modal(document.getElementById('leagueModal'));
        const bannerModal = new bootstrap.Modal(document.getElementById('bannerModal'));

        // ================= DASHBOARD STATS =================
        onValue(ref(db, 'active_users'), (snapshot) => { document.getElementById('activeUsers').innerText = snapshot.exists() ? snapshot.size : 0; });
        onValue(ref(db, 'leagues'), (snapshot) => { document.getElementById('totalLeagues').innerText = snapshot.exists() ? snapshot.size : 0; });
        onValue(ref(db, 'channels'), (snapshot) => { document.getElementById('totalChannels').innerText = snapshot.exists() ? snapshot.size : 0; });
        
        // ================= BANNER / SLIDER MANAGER (NEW LOGIC) =================
        onValue(ref(db, 'banners'), (snapshot) => {
            const count = snapshot.exists() ? snapshot.size : 0;
            document.getElementById('totalBanners').innerText = count;
            
            const tbody = document.getElementById('bannerTableBody');
            tbody.innerHTML = '';
            if(snapshot.exists()) {
                const arr = [];
                snapshot.forEach((child) => { arr.push({key: child.key, ...child.val()}); });
                arr.sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));

                arr.forEach(v => {
                    tbody.innerHTML += `
                        <tr data-id="${v.key}" class="draggable-row">
                            <td class="ps-4 text-secondary"><i class="fa-solid fa-bars" style="cursor: grab;"></i></td>
                            <td class="ps-2"><img src="${v.image}" class="banner-img-preview" onerror="this.src='https://via.placeholder.com/120x60'"></td>
                            <td class="text-white">${v.title || '<span class="text-secondary">No Title</span>'}</td>
                            <td><span class="badge bg-secondary text-truncate" style="max-width: 200px;">${v.link}</span></td>
                            <td class="text-end pe-4">
                                <button class="btn btn-sm btn-outline-info me-2" onclick="window.editBanner('${v.key}', '${v.image}', '${v.link}', '${v.title || ''}')"><i class="fa-solid fa-pen"></i></button>
                                <button class="btn btn-sm btn-outline-danger" onclick="window.deleteBanner('${v.key}')"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
            }
        });

        // Banner Functions
        new Sortable(document.getElementById('bannerTableBody'), { animation: 150, handle: '.fa-bars', onEnd: function (evt) { document.querySelectorAll('#bannerTableBody tr').forEach((row, index) => { update(ref(db, 'banners/' + row.getAttribute('data-id')), { sortOrder: index }); }); } });
        
        document.getElementById('saveBannerBtn').addEventListener('click', () => {
            const key = document.getElementById('bnrEditKey').value;
            const data = { 
                image: document.getElementById('bnrImage').value, 
                link: document.getElementById('bnrLink').value, 
                title: document.getElementById('bnrTitle').value,
                sortOrder: key ? undefined : 9999 
            };
            if(key) delete data.sortOrder;
            if(!data.image || !data.link) { Swal.fire('Error', 'Image and Link are required!', 'error'); return; }
            
            if(key) { update(ref(db, 'banners/' + key), data).then(() => { Swal.fire('Success', 'Updated', 'success'); bannerModal.hide(); }); } 
            else { push(ref(db, 'banners'), data).then(() => { Swal.fire('Success', 'Added', 'success'); bannerModal.hide(); }); }
        });

        window.editBanner = function(key, image, link, title) {
            document.getElementById('bnrEditKey').value = key;
            document.getElementById('bnrImage').value = image;
            document.getElementById('bnrLink').value = link;
            document.getElementById('bnrTitle').value = title;
            document.getElementById('bnrModalTitle').innerText = "Edit Slider";
            bannerModal.show();
        }
        window.deleteBanner = function(key) { Swal.fire({ title: 'Delete?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' }).then((res) => { if (res.isConfirmed) remove(ref(db, 'banners/' + key)); }); }
        window.resetBannerForm = function() {
            document.getElementById('bnrEditKey').value = "";
            document.getElementById('bnrImage').value = "";
            document.getElementById('bnrLink').value = "";
            document.getElementById('bnrTitle').value = "";
            document.getElementById('bnrModalTitle').innerText = "Add New Slider";
        }


        // ================= LEAGUE FUNCTIONS (UPDATED) =================
        onValue(ref(db, 'leagues'), (snapshot) => {
            const tbody = document.getElementById('leagueTableBody');
            tbody.innerHTML = '';
            if(snapshot.exists()) {
                const leaguesArr = [];
                snapshot.forEach((child) => { leaguesArr.push({key: child.key, ...child.val()}); });
                leaguesArr.sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));

                leaguesArr.forEach(v => {
                    const shortLink = v.link.length > 20 ? v.link.substring(0, 20) + '...' : v.link;
                    tbody.innerHTML += `
                        <tr data-id="${v.key}" class="draggable-row">
                            <td class="ps-4 text-secondary"><i class="fa-solid fa-bars" style="cursor: grab;"></i></td>
                            <td class="ps-2"><img src="${v.logo}" class="channel-img-preview" onerror="this.src='https://via.placeholder.com/40'"></td>
                            <td class="text-white fw-bold">${v.name}</td>
                            <td><span class="badge bg-info text-dark">${v.category || 'N/A'}</span></td>
                            <td><span class="badge bg-secondary text-truncate" style="max-width: 150px;">${shortLink}</span></td>
                            <td class="text-end pe-4">
                                <button class="btn btn-sm btn-outline-info me-2" onclick="window.editLeague('${v.key}', '${v.name}', '${v.category || ''}', '${v.logo}', '${v.link}', '${v.link2||''}', '${v.link3||''}')"><i class="fa-solid fa-pen"></i></button>
                                <button class="btn btn-sm btn-outline-danger" onclick="window.deleteLeague('${v.key}')"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
            }
        });

        new Sortable(document.getElementById('leagueTableBody'), { animation: 150, handle: '.fa-bars', onEnd: function (evt) { document.querySelectorAll('#leagueTableBody tr').forEach((row, index) => { update(ref(db, 'leagues/' + row.getAttribute('data-id')), { sortOrder: index }); }); } });
        
        document.getElementById('saveLeagueBtn').addEventListener('click', () => {
            const key = document.getElementById('lgEditKey').value;
            // Removed Banner Fields
            const data = { 
                name: document.getElementById('lgName').value, 
                category: document.getElementById('lgCat').value, 
                logo: document.getElementById('lgLogo').value, 
                link: document.getElementById('lgSource1').value, 
                link2: document.getElementById('lgLink2').value, 
                link3: document.getElementById('lgLink3').value, 
                sortOrder: key ? undefined : 9999 
            };
            if(key) delete data.sortOrder;
            if(!data.name || !data.link) { Swal.fire('Error', 'Required fields missing!', 'error'); return; }
            if(key) { update(ref(db, 'leagues/' + key), data).then(() => { Swal.fire('Success', 'Updated', 'success'); leagueModal.hide(); }); } else { push(ref(db, 'leagues'), data).then(() => { Swal.fire('Success', 'Added', 'success'); leagueModal.hide(); }); }
        });
        
        // Removed banner params from edit function
        window.editLeague = function(key, name, cat, logo, l1, l2, l3) { 
            document.getElementById('lgEditKey').value = key; 
            document.getElementById('lgName').value = name; 
            document.getElementById('lgCat').value = cat; 
            document.getElementById('lgLogo').value = logo; 
            document.getElementById('lgSource1').value = l1; 
            document.getElementById('lgLink2').value = l2; 
            document.getElementById('lgLink3').value = l3; 
            document.getElementById('lgModalTitle').innerText = "Edit League"; 
            leagueModal.show(); 
        }
        window.deleteLeague = function(key) { Swal.fire({ title: 'Delete?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' }).then((res) => { if (res.isConfirmed) remove(ref(db, 'leagues/' + key)); }); }
        window.resetLeagueForm = function() { 
            document.getElementById('lgEditKey').value = ""; 
            document.getElementById('lgName').value = ""; 
            document.getElementById('lgCat').value = ""; 
            document.getElementById('lgLogo').value = ""; 
            document.getElementById('lgSource1').value = ""; 
            document.getElementById('lgLink2').value = ""; 
            document.getElementById('lgLink3').value = ""; 
            document.getElementById('lgModalTitle').innerText = "Add New League"; 
        }

        // ================= APP SETTINGS =================
        const settingsRef = ref(db, 'app_settings');
        onValue(settingsRef, (snap) => {
            if(snap.exists()) {
                const data = snap.val();
                document.getElementById('requestUrl').value = data.request_url || '';
                document.getElementById('shareUrl').value = data.share_url || '';
                document.getElementById('aboutText').value = data.about_text || '';
            }
        });
        document.getElementById('saveSettingsBtn').addEventListener('click', () => { update(settingsRef, { request_url: document.getElementById('requestUrl').value, share_url: document.getElementById('shareUrl').value, about_text: document.getElementById('aboutText').value }).then(() => { Swal.fire('Saved!', 'Settings updated.', 'success'); }); });

        // ================= ADS MANAGER =================
        const adsRef = ref(db, 'app_settings/ads');
        onValue(adsRef, (snapshot) => {
            if(snapshot.exists()) {
                const ads = snapshot.val();
                document.getElementById('adPopCode').value = ads.popunder?.code || '';
                document.getElementById('adPopStatus').checked = ads.popunder?.active || false;
                document.getElementById('adNativeCode').value = ads.native?.code || '';
                document.getElementById('adNativeStatus').checked = ads.native?.active || false;
                document.getElementById('adStickyCode').value = ads.sticky?.code || '';
                document.getElementById('adStickyStatus').checked = ads.sticky?.active || false;
            }
        });
        document.getElementById('saveAdsBtn').addEventListener('click', () => {
            const adsData = { popunder: { code: document.getElementById('adPopCode').value, active: document.getElementById('adPopStatus').checked }, native: { code: document.getElementById('adNativeCode').value, active: document.getElementById('adNativeStatus').checked }, sticky: { code: document.getElementById('adStickyCode').value, active: document.getElementById('adStickyStatus').checked } };
            set(adsRef, adsData).then(() => Swal.fire('Saved!', 'Ad settings updated.', 'success'));
        });

        // ================= LEAGUE CATEGORY FUNCTIONS =================
        new Sortable(document.getElementById('lgCatTableBody'), { animation: 150, handle: '.fa-bars', onEnd: function (evt) { document.querySelectorAll('#lgCatTableBody tr').forEach((row, index) => { update(ref(db, 'league_categories/' + row.getAttribute('data-id')), { sortOrder: index }); }); } });
        document.getElementById('btnAddLgCat').addEventListener('click', () => { const catName = document.getElementById('newLgCatName').value; if(catName) { push(ref(db, 'league_categories'), { name: catName, sortOrder: 9999 }).then(() => { Swal.fire('Success', 'Category Added!', 'success'); document.getElementById('newLgCatName').value = ''; }); } });
        window.editLgCat = async function(key, oldName) { const { value: newName } = await Swal.fire({ title: 'Rename Category', input: 'text', inputValue: oldName, showCancelButton: true }); if (newName && newName !== oldName) { update(ref(db, 'league_categories/' + key), { name: newName }); } };
        onValue(ref(db, 'league_categories'), (snapshot) => { const tbody = document.getElementById('lgCatTableBody'); const dropdown = document.getElementById('lgCat'); tbody.innerHTML = ''; dropdown.innerHTML = '<option value="">Select Category...</option>'; if(snapshot.exists()) { const catArr = []; snapshot.forEach((child) => { catArr.push({key: child.key, ...child.val()}); }); catArr.sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0)); catArr.forEach(v => { tbody.innerHTML += `<tr data-id="${v.key}" class="draggable-row"><td class="ps-4 text-secondary"><i class="fa-solid fa-bars" style="cursor: grab;"></i></td><td>${v.name}</td><td class="text-end pe-4"><button class="btn btn-sm btn-outline-warning me-2" onclick="window.editLgCat('${v.key}', '${v.name}')"><i class="fa-solid fa-pen"></i></button><button class="btn btn-sm btn-outline-danger" onclick="window.deleteLgCat('${v.key}')"><i class="fa-solid fa-trash"></i></button></td></tr>`; dropdown.innerHTML += `<option value="${v.name}">${v.name}</option>`; }); } });
        window.deleteLgCat = function(key) { remove(ref(db, 'league_categories/' + key)); }

        // ================= CHANNEL FUNCTIONS =================
        window.allChannelsData = [];
        document.getElementById('channelFilter').addEventListener('change', function() { renderChannelTable(this.value); });
        function renderChannelTable(filterCat = "All") { const tbody = document.getElementById('channelTableBody'); tbody.innerHTML = ''; let displayData = window.allChannelsData; if(filterCat !== "All") { displayData = window.allChannelsData.filter(ch => ch.category === filterCat); } displayData.forEach(v => { tbody.innerHTML += `<tr data-id="${v.key}" class="draggable-row"><td class="ps-4 text-secondary"><i class="fa-solid fa-bars" style="cursor: grab;"></i></td><td class="ps-2"><img src="${v.logo}" class="channel-img-preview" onerror="this.src='https://via.placeholder.com/40'"></td><td class="text-white fw-bold">${v.name}</td><td><span class="badge bg-secondary">${v.category}</span></td><td class="text-end pe-4"><button class="btn btn-sm btn-outline-info me-2" onclick="window.editChannel('${v.key}', '${v.name}', '${v.logo}', '${v.category}', '${v.link}', '${v.link2 || ''}', '${v.link3 || ''}')"><i class="fa-solid fa-pen"></i></button><button class="btn btn-sm btn-outline-danger" onclick="window.deleteChannel('${v.key}')"><i class="fa-solid fa-trash"></i></button></td></tr>`; }); }
        onValue(ref(db, 'channels'), (snapshot) => { let count = 0; window.allChannelsData = []; if(snapshot.exists()) { snapshot.forEach((child) => { window.allChannelsData.push({key: child.key, ...child.val()}); }); window.allChannelsData.sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0)); count = window.allChannelsData.length; } document.getElementById('totalChannels').innerText = count; renderChannelTable(document.getElementById('channelFilter').value); });
        document.getElementById('saveChannelBtn').addEventListener('click', () => { const key = document.getElementById('chEditKey').value; const data = { name: document.getElementById('chName').value, category: document.getElementById('chCat').value, logo: document.getElementById('chLogo').value, link: document.getElementById('chLink').value, link2: document.getElementById('chLink2').value, link3: document.getElementById('chLink3').value, sortOrder: key ? undefined : 9999 }; if(key) delete data.sortOrder; if(!data.name || !data.link) { Swal.fire('Error', 'Data missing!', 'error'); return; } if(key) { update(ref(db, 'channels/' + key), data).then(() => { Swal.fire('Success', 'Updated', 'success'); channelModal.hide(); }); } else { push(ref(db, 'channels'), data).then(() => { Swal.fire('Success', 'Added', 'success'); channelModal.hide(); }); } });
        new Sortable(document.getElementById('channelTableBody'), { animation: 150, handle: '.fa-bars', onEnd: function (evt) { document.querySelectorAll('#channelTableBody tr').forEach((row, index) => { update(ref(db, 'channels/' + row.getAttribute('data-id')), { sortOrder: index }); }); } });
        window.editChannel = function(key, name, logo, cat, link, link2, link3) { document.getElementById('chEditKey').value = key; document.getElementById('chName').value = name; document.getElementById('chLogo').value = logo; document.getElementById('chCat').value = cat; document.getElementById('chLink').value = link; document.getElementById('chLink2').value = link2; document.getElementById('chLink3').value = link3; document.getElementById('chModalTitle').innerText = "Edit Channel"; channelModal.show(); }
        window.deleteChannel = function(key) { Swal.fire({ title: 'Delete?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' }).then((res) => { if (res.isConfirmed) remove(ref(db, 'channels/' + key)); }); }
        window.resetForm = function() { document.getElementById('chEditKey').value = ""; document.getElementById('chName').value = ""; document.getElementById('chLogo').value = ""; const filterVal = document.getElementById('channelFilter').value; document.getElementById('chCat').value = filterVal === "All" ? "" : filterVal; document.getElementById('chLink').value = ""; document.getElementById('chLink2').value = ""; document.getElementById('chLink3').value = ""; document.getElementById('chModalTitle').innerText = "Add New Channel"; }

        // ================= CHANNEL CAT FUNCTIONS =================
        new Sortable(document.getElementById('catTableBody'), { animation: 150, handle: '.fa-bars', onEnd: function (evt) { document.querySelectorAll('#catTableBody tr').forEach((row, index) => { update(ref(db, 'categories/' + row.getAttribute('data-id')), { sortOrder: index }); }); } });
        document.getElementById('btnAddCat').addEventListener('click', () => { const catName = document.getElementById('newCatName').value; if(catName) { push(ref(db, 'categories'), { name: catName, sortOrder: 9999 }).then(() => { Swal.fire('Success', 'Category Added!', 'success'); document.getElementById('newCatName').value = ''; }); } });
        window.editCat = async function(key, oldName) { const { value: newName } = await Swal.fire({ title: 'Rename Category', input: 'text', inputValue: oldName, showCancelButton: true }); if (newName && newName !== oldName) { update(ref(db, 'categories/' + key), { name: newName }); } };
        onValue(ref(db, 'categories'), (snapshot) => { const tbody = document.getElementById('catTableBody'); const dropdown = document.getElementById('chCat'); const filterDropdown = document.getElementById('channelFilter'); tbody.innerHTML = ''; dropdown.innerHTML = '<option value="">Select Category...</option>'; const currentFilter = filterDropdown.value; filterDropdown.innerHTML = '<option value="All">All Categories</option>'; if(snapshot.exists()) { const catArr = []; snapshot.forEach((child) => { catArr.push({key: child.key, ...child.val()}); }); catArr.sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0)); catArr.forEach(v => { tbody.innerHTML += `<tr data-id="${v.key}" class="draggable-row"><td class="ps-4 text-secondary"><i class="fa-solid fa-bars" style="cursor: grab;"></i></td><td>${v.name}</td><td class="text-end pe-4"><button class="btn btn-sm btn-outline-warning me-2" onclick="window.editCat('${v.key}', '${v.name}')"><i class="fa-solid fa-pen"></i></button><button class="btn btn-sm btn-outline-danger" onclick="window.deleteCat('${v.key}')"><i class="fa-solid fa-trash"></i></button></td></tr>`; dropdown.innerHTML += `<option value="${v.name}">${v.name}</option>`; filterDropdown.innerHTML += `<option value="${v.name}">${v.name}</option>`; }); document.getElementById('totalCats').innerText = catArr.length; } filterDropdown.value = currentFilter; });
        window.deleteCat = function(key) { remove(ref(db, 'categories/' + key)); }

        // Section Switcher
        window.showSection = function(id) {
            ['dashboard', 'settings', 'ads', 'leagues', 'league-cats', 'categories', 'channels', 'banners'].forEach(sec => {
                const el = document.getElementById('section-' + sec);
                if(el) el.style.display = 'none';
            });
            document.getElementById('section-' + id).style.display = 'block';
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }
    </script>
</body>
</html>